#!/bin/sh
set -e
ARCH=`uname -m`
REMI_URL=http://ftp.riken.jp/Linux/remi/enterprise/9/safe/$ARCH/
for i in php php-common php-intl php-pdo php-mysqlnd php-gd php-json php-xml php-mbstring php-fpm php-cli php-process php-smbclient php-pecl-zip php-pecl-apcu; do
        download `get-rpm-download-url $REMI_URL php74-$i` > /tmp/$i.rpm
done
for i in oniguruma5php gd3php libavif libicu73; do
	download `get-rpm-download-url $REMI_URL $i` > /tmp/$i.rpm
done

CENTOS_URL=http://ftp.riken.jp/Linux/centos-stream/9-stream/BaseOS/$ARCH/os/
for i in libxml2 libsmbclient samba-client-libs libwbclient libicu; do
	download `get-rpm-download-url $CENTOS_URL $i` > /tmp/$i.rpm
done

EPEL_URL=http://ftp.riken.jp/Linux/fedora/epel/9/Everything/$ARCH/
for i in libraqm svt-av1-libs; do
	download `get-rpm-download-url $EPEL_URL $i` > /tmp/$i.rpm
done

ls -l /tmp/*.rpm

for i in /tmp/*.rpm; do
        rpm2targz -O $i | tar zxvf - -C /
done

sed -i 's/^pdo_mysql\.default_socket=.*$/pdo_mysql.default_socket=\/run\/mysqld\/mysqld.sock/' /etc/opt/remi/php74/php.ini
sed -i 's/^mysqli\.default_socket =.*$/mysqli.default_socket = \/run\/mysqld\/mysqld.sock/' /etc/opt/remi/php74/php.ini

ln -sf php74 /usr/bin/php
chown -R root:apache /var/opt/remi/php74/lib/php/opcache /var/opt/remi/php74/lib/php/session /var/opt/remi/php74/lib/php/wsdlcache

if [ -d /etc/apache2/modules.d ]; then
	ln -s /etc/httpd/conf.d/php74-php.conf /etc/apache2/modules.d/70_remi_php74_php.conf
fi

