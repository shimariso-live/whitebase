#!/bin/sh
set -e
VERSION=`file -L /boot/kernel| sed 's/^.\+ version \([^ ]\+\)\s.\+$/\1/'|sed 's/-gentoo//'`
sed -i "s/__VERSION__/$VERSION/g" /boot/grub/grub.cfg

# services preferred by installer/rescue env
sed -i 's/^WantedBy=multi-user.target$/WantedBy=multi-user.target installer.target transient.target/' /lib/systemd/system/systemd-networkd.service
sed -i 's/^WantedBy=multi-user.target$/WantedBy=multi-user.target installer.target transient.target/' /lib/systemd/system/systemd-resolved.service
sed -i 's/^WantedBy=multi-user.target$/WantedBy=multi-user.target installer.target transient.target/' /lib/systemd/system/sshd.service
sed -i 's/^WantedBy=multi-user.target$/WantedBy=multi-user.target installer.target transient.target/' /lib/systemd/system/openvpn-client@.service
sed -i 's/^WantedBy=multi-user.target$/WantedBy=multi-user.target installer.target transient.target/' /lib/systemd/system/zabbix-agentd.service

g++ -std=c++2a -o /usr/sbin/genpack-install /usr/src/genpack-install.cpp -lmount -lblkid
touch /usr/sbin/do-with-lvm-snapshot
touch /usr/sbin/rpmbootstrap
touch /usr/sbin/genbootstrap

g++ -std=c++2a -o /usr/sbin/wait-for-display /usr/src/wait-for-display.cpp -lwayland-client

#/etc/udev/hwdb.bin
#/usr/bin/cpuid2cpuflags
#$copy walbrix/arcconf /opt/bin/arcconf
#$require nut.lst
#$require omronups.lst
#$require s3fs.lst

cd /usr/src/walbrix
make
make install

mkdir -p /var/vm/\@default

systemctl enable mdmonitor walbrixd ui

